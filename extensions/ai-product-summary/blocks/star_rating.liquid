{% comment %}
  AI Product Review Summary Block
  Displays AI-generated product reviews summary
{% endcomment %}

<style>
  .ai-review-block { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
  .ai-review-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 14px; font-weight: 600; color: #9c6ade; text-transform: uppercase; letter-spacing: 0.5px; }
  .ai-review-icon { font-size: 18px; }
  .ai-review-content { color: #4a5568; line-height: 1.6; font-size: 15px; }
  .ai-review-loading { color: #9c6ade; font-style: italic; }

  .ai-suggestions-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
  }

  .ai-suggestions-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    font-size: 14px;
    font-weight: 600;
    color: #9c6ade;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .ai-suggestions-icon {
    font-size: 18px;
  }

  .ai-suggestions-content {
    color: #4a5568;
    line-height: 1.6;
    font-size: 15px;
    white-space: pre-wrap;
  }

  .ai-suggestions-loading {
    color: #9c6ade;
    font-style: italic;
  }

  @media (max-width: 768px) {
    .ai-review-block { padding: 16px; }
    .ai-review-content,
    .ai-suggestions-content { font-size: 14px; }
  }
</style>

<div class="ai-review-block" id="ai-review-{{ product.id }}" data-product-title="{{ product.title | escape }}">
  <div class="ai-review-header">
    <span class="ai-review-icon">‚≠ê</span>
    <span>AI Reviews</span>
  </div>
  <div class="ai-review-content demo ai-review-loading">Loading AI review summary...</div>
  <div class="ai-suggestions-section" id="ai-suggestions-{{ product.id }}" style="display: none;">
    <div class="ai-suggestions-header">
      <span class="ai-suggestions-icon">üí°</span>
      <span>Suggestions</span>
    </div>
    <div class="ai-suggestions-content ai-suggestions-loading">
      Loading suggestions...
    </div>
  </div>
</div>

<script>
(function() {
  const productTitle = "{{ product.title | escape }}";
  const reviewBlock = document.getElementById('ai-review-{{ product.id }}');
  const contentDiv = reviewBlock.querySelector('.ai-review-content');
  const suggestionsSection = document.getElementById('ai-suggestions-{{ product.id }}');
  const suggestionsContent = suggestionsSection.querySelector('.ai-suggestions-content');

  console.log('[AI Reviews] Fetching data for product:', productTitle);

  fetch(`/apps/ai-review-summary?type=review&product=${encodeURIComponent(productTitle)}`)
    .then(res => {
      console.log('[AI Reviews] Response status:', res.status);
      return res.json();
    })
    .then(data => {
      console.log('[AI Reviews] Received data:', data);
      contentDiv.classList.remove('ai-review-loading');

      if(data.success){
        // If reviews exist
        if(data.reviews && data.reviews.length > 0){
          contentDiv.innerHTML = data.reviews.map(r => `<p><strong>${r.user}:</strong> ${r.comment}</p>`).join('');
        }
        // If no reviews but summary exists
        else if(data.summary){
          contentDiv.textContent = data.summary;
        }
        // If nothing exists
        else {
          contentDiv.textContent = "No reviews available for this product.";
        }

        // Display suggestions if available
        if (data.suggestions) {
          console.log('[AI Reviews] Suggestions found:', data.suggestions);
          // Display suggestions directly without extraction
          suggestionsContent.textContent = data.suggestions;
          suggestionsContent.classList.remove('ai-suggestions-loading');
          suggestionsSection.style.display = 'block';
          console.log('[AI Reviews] Suggestions section displayed');
        } else {
          console.log('[AI Reviews] No suggestions available in response');
        }
      } else {
        contentDiv.textContent = data.message || "Failed to load reviews.";
      }
    })
    .catch(err => {
      console.error('[AI Reviews] Error loading AI reviews:', err);
      contentDiv.textContent = "Error loading AI reviews.";
    });
})();
</script>

{% schema %}
{
  "name": "Product AI Review Summary",
  "target": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Displays AI-generated product reviews summary from your backend. Fallbacks show summary or message if reviews are missing."
    }
  ]
}
{% endschema %}